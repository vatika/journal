---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection, getEntryBySlug } from 'astro:content';

export async function getStaticPaths() {
  const books = await getCollection('books');
  return books.map((book) => ({
    params: { slug: book.slug },
  }));
}

const { slug } = Astro.params;

const book = await getEntryBySlug('books', slug!);
if (!book) throw new Error(`Book not found: ${slug}`);

const { Content } = await book.render();

function stars(n: number) {
  return '★'.repeat(n) + '☆'.repeat(5 - n);
}

const base = import.meta.env.BASE_URL.replace(/\/$/, '');
const asset = (p: string) => `${base}/${p.replace(/^\//, '')}`;
---

<BaseLayout title={`${book.data.title} — Reading Journal`}>
  <a class="muted" href={`${base}/reading/books/${book.data.finished.slice(0, 4)}`} style="font-size: 13px;">← Back to year</a>

  <div class="card" style="margin-top: 12px; display:grid; grid-template-columns: 120px 1fr; gap: 18px; align-items:start;">
    <img
      src={asset(book.data.cover)}
      alt={`Cover of ${book.data.title}`}
      style="width:120px; height:180px; object-fit:cover; border-radius:12px; box-shadow: 0 12px 28px rgba(0,0,0,0.14);"
    />

    <div>
      <h1 style="margin-top:0; font-size: 32px;">{book.data.title}</h1>

      <div class="meta" style="margin-top: 6px;">
          {book.data.author} · Finished {book.data.finished}
          {book.data.goodreads && (
            <span> · <a href={book.data.goodreads} target="_blank" rel="noopener noreferrer">Goodreads</a></span>
          )}
        </div>

      <div class="stars">{stars(book.data.rating)}</div>

      <p class="tldr" style="font-style: italic; margin-top: 14px;">
        {book.data.tldr}
      </p>
    </div>

    <article style="grid-column: 1 / -1; border-top: 1px solid var(--border); margin-top: 10px; padding-top: 10px;">
      <Content />
    </article>
  </div>
</BaseLayout>
