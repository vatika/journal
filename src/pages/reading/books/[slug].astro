---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection, getEntryBySlug } from 'astro:content';

export async function getStaticPaths() {
  const books = await getCollection('books');
  return books.map((book) => ({
    params: { slug: book.slug },
  }));
}

const { slug } = Astro.params;

const book = await getEntryBySlug('books', slug!);
if (!book) throw new Error(`Book not found: ${slug}`);

const { Content } = await book.render();

function stars(n: number) {
  return '★'.repeat(n) + '☆'.repeat(5 - n);
}

const base = import.meta.env.BASE_URL.replace(/\/$/, '');
const asset = (p: string) => `${base}/${p.replace(/^\//, '')}`;
---

<BaseLayout title={`${book.data.title} — Reading Journal`}>
  <a class="muted" href={`${base}/reading/books/${book.data.finished.slice(0, 4)}`}>← Back to year</a>

  <hr class="sep" />

  <div class="card" style="display:grid; grid-template-columns: 160px 1fr; gap: 22px; align-items:start;">
    <img
      src={asset(book.data.cover)}
      alt={`Cover of ${book.data.title}`}
      style="width:160px; height:240px; object-fit:cover; border-radius:16px; box-shadow: 0 16px 34px rgba(0,0,0,0.14);"
    />

    <div>
      <h1 style="margin-top:0;">{book.data.title}</h1>

      <div class="meta" style="margin-top: 6px;">
        {book.data.author} · Finished {book.data.finished}
      </div>

      <div class="stars">{stars(book.data.rating)}</div>

      <p class="tldr" style="font-style: italic; margin-top: 14px;">
        {book.data.tldr}
      </p>
    </div>
  </div>

  <h2 style="margin-top: 42px;">Notes</h2>
  <div class="card">
    <article>
      <Content />
    </article>
  </div>
</BaseLayout>
